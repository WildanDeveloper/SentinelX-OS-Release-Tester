#!/usr/bin/env python3
"""
SentinelX OS - Configuration Manager
Centralized system configuration management
"""

import os
import sys
import json
import yaml
import shutil
from pathlib import Path
from datetime import datetime

class SentinelXConfig:
    def __init__(self):
        self.config_root = Path("/etc/sentinelx")
        self.config_file = self.config_root / "system.conf"
        self.backup_dir = self.config_root / "backups"
        
        # Create directories
        self.config_root.mkdir(parents=True, exist_ok=True)
        self.backup_dir.mkdir(parents=True, exist_ok=True)
        
        # Load or create default config
        self.config = self.load_config()
    
    def load_config(self):
        """Load system configuration"""
        if self.config_file.exists():
            try:
                with open(self.config_file, 'r') as f:
                    return json.load(f)
            except Exception as e:
                print(f"Error loading config: {e}")
                return self.default_config()
        else:
            return self.default_config()
    
    def default_config(self):
        """Return default configuration"""
        return {
            'system': {
                'hostname': 'sentinelx',
                'timezone': 'UTC',
                'locale': 'en_US.UTF-8',
                'keymap': 'us'
            },
            'kernel': {
                'version': '6.12-sx',
                'parameters': [
                    'quiet',
                    'splash',
                    'loglevel=3'
                ],
                'modules': {
                    'blacklist': [],
                    'autoload': []
                }
            },
            'packages': {
                'pacman': {
                    'enabled': True,
                    'mirrors': [
                        'https://mirror.archlinux.org/$repo/os/$arch'
                    ]
                },
                'rpm': {
                    'enabled': True,
                    'repos': [
                        'https://download.fedoraproject.org/pub/fedora/linux/releases/$releasever/Everything/$basearch/os/'
                    ]
                },
                'aur': {
                    'enabled': True,
                    'helper': 'yay'
                }
            },
            'security': {
                'apparmor': {
                    'enabled': True,
                    'complain_mode': False
                },
                'selinux': {
                    'enabled': True,
                    'mode': 'enforcing',
                    'type': 'targeted'
                },
                'firewall': {
                    'enabled': True,
                    'default_zone': 'public'
                }
            },
            'network': {
                'backend': 'NetworkManager',
                'dns_servers': ['8.8.8.8', '8.8.4.4']
            },
            'desktop': {
                'default_session': 'wayland',
                'compositor': 'sx-shell',
                'theme': 'sentinelx-dark'
            },
            'services': {
                'enabled': [
                    'NetworkManager',
                    'sshd',
                    'systemd-timesyncd'
                ],
                'disabled': []
            },
            'performance': {
                'cpu_governor': 'schedutil',
                'io_scheduler': 'mq-deadline',
                'swappiness': 10
            }
        }
    
    def save_config(self):
        """Save configuration to file"""
        # Backup existing config
        if self.config_file.exists():
            backup_name = f"system.conf.{datetime.now().strftime('%Y%m%d-%H%M%S')}"
            backup_path = self.backup_dir / backup_name
            shutil.copy2(self.config_file, backup_path)
            print(f"Backed up current config to: {backup_path}")
        
        # Save new config
        with open(self.config_file, 'w') as f:
            json.dump(self.config, f, indent=2)
        
        print(f"Configuration saved to: {self.config_file}")
    
    def get(self, key_path):
        """Get configuration value by key path (e.g., 'system.hostname')"""
        keys = key_path.split('.')
        value = self.config
        
        for key in keys:
            if isinstance(value, dict) and key in value:
                value = value[key]
            else:
                return None
        
        return value
    
    def set(self, key_path, value):
        """Set configuration value by key path"""
        keys = key_path.split('.')
        config = self.config
        
        # Navigate to the parent dict
        for key in keys[:-1]:
            if key not in config:
                config[key] = {}
            config = config[key]
        
        # Set the value
        config[keys[-1]] = value
        print(f"Set {key_path} = {value}")
    
    def apply_system_config(self):
        """Apply system configuration"""
        print("Applying system configuration...")
        
        # Hostname
        hostname = self.get('system.hostname')
        if hostname:
            os.system(f"hostnamectl set-hostname {hostname}")
            print(f"✓ Hostname set to: {hostname}")
        
        # Timezone
        timezone = self.get('system.timezone')
        if timezone:
            os.system(f"timedatectl set-timezone {timezone}")
            print(f"✓ Timezone set to: {timezone}")
        
        # Locale
        locale = self.get('system.locale')
        if locale:
            with open('/etc/locale.conf', 'w') as f:
                f.write(f"LANG={locale}\n")
            print(f"✓ Locale set to: {locale}")
    
    def apply_security_config(self):
        """Apply security configuration"""
        print("Applying security configuration...")
        
        # AppArmor
        if self.get('security.apparmor.enabled'):
            os.system("systemctl enable --now apparmor")
            print("✓ AppArmor enabled")
        
        # SELinux
        if self.get('security.selinux.enabled'):
            mode = self.get('security.selinux.mode')
            # Note: SELinux mode change requires reboot
            print(f"✓ SELinux configured (mode: {mode}, requires reboot)")
        
        # Firewall
        if self.get('security.firewall.enabled'):
            os.system("systemctl enable --now firewalld")
            print("✓ Firewall enabled")
    
    def apply_performance_config(self):
        """Apply performance tuning"""
        print("Applying performance configuration...")
        
        # CPU Governor
        governor = self.get('performance.cpu_governor')
        if governor:
            os.system(f"echo {governor} | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor")
            print(f"✓ CPU governor set to: {governor}")
        
        # Swappiness
        swappiness = self.get('performance.swappiness')
        if swappiness is not None:
            os.system(f"sysctl vm.swappiness={swappiness}")
            print(f"✓ Swappiness set to: {swappiness}")
    
    def apply_all(self):
        """Apply all configurations"""
        print("=" * 60)
        print("  Applying SentinelX OS Configuration")
        print("=" * 60)
        print()
        
        try:
            self.apply_system_config()
            print()
            self.apply_security_config()
            print()
            self.apply_performance_config()
            print()
            print("=" * 60)
            print("  Configuration applied successfully!")
            print("=" * 60)
        except Exception as e:
            print(f"Error applying configuration: {e}")
    
    def export_config(self, format='json'):
        """Export configuration to different formats"""
        export_file = f"/tmp/sentinelx-config-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
        
        if format == 'json':
            export_file += '.json'
            with open(export_file, 'w') as f:
                json.dump(self.config, f, indent=2)
        elif format == 'yaml':
            export_file += '.yaml'
            with open(export_file, 'w') as f:
                yaml.dump(self.config, f, default_flow_style=False)
        
        print(f"Configuration exported to: {export_file}")
        return export_file
    
    def import_config(self, file_path):
        """Import configuration from file"""
        file_path = Path(file_path)
        
        if not file_path.exists():
            print(f"Error: File not found: {file_path}")
            return False
        
        try:
            with open(file_path, 'r') as f:
                if file_path.suffix == '.json':
                    self.config = json.load(f)
                elif file_path.suffix in ['.yaml', '.yml']:
                    self.config = yaml.safe_load(f)
                else:
                    print(f"Error: Unsupported file format: {file_path.suffix}")
                    return False
            
            print(f"Configuration imported from: {file_path}")
            return True
        except Exception as e:
            print(f"Error importing configuration: {e}")
            return False
    
    def show_config(self, section=None):
        """Display configuration"""
        print("=" * 60)
        print("  SentinelX OS Configuration")
        print("=" * 60)
        print()
        
        if section:
            config_section = self.get(section)
            if config_section:
                print(json.dumps({section: config_section}, indent=2))
            else:
                print(f"Section not found: {section}")
        else:
            print(json.dumps(self.config, indent=2))
    
    def reset_to_defaults(self):
        """Reset configuration to defaults"""
        print("Resetting configuration to defaults...")
        self.config = self.default_config()
        self.save_config()
        print("Configuration reset to defaults")

def main():
    if os.geteuid() != 0:
        print("Warning: Some operations require root privileges")
    
    config = SentinelXConfig()
    
    if len(sys.argv) < 2:
        config.show_config()
        return
    
    command = sys.argv[1]
    
    if command == 'get':
        if len(sys.argv) < 3:
            print("Usage: sx-config get <key>")
            sys.exit(1)
        value = config.get(sys.argv[2])
        if value is not None:
            print(json.dumps(value, indent=2))
        else:
            print(f"Key not found: {sys.argv[2]}")
    
    elif command == 'set':
        if len(sys.argv) < 4:
            print("Usage: sx-config set <key> <value>")
            sys.exit(1)
        config.set(sys.argv[2], sys.argv[3])
        config.save_config()
    
    elif command == 'apply':
        config.apply_all()
    
    elif command == 'export':
        format_type = sys.argv[2] if len(sys.argv) > 2 else 'json'
        config.export_config(format_type)
    
    elif command == 'import':
        if len(sys.argv) < 3:
            print("Usage: sx-config import <file>")
            sys.exit(1)
        if config.import_config(sys.argv[2]):
            config.save_config()
    
    elif command == 'show':
        section = sys.argv[2] if len(sys.argv) > 2 else None
        config.show_config(section)
    
    elif command == 'reset':
        config.reset_to_defaults()
    
    elif command == 'save':
        config.save_config()
    
    else:
        print(f"Unknown command: {command}")
        print("\nAvailable commands:")
        print("  get <key>           Get configuration value")
        print("  set <key> <value>   Set configuration value")
        print("  apply               Apply all configurations")
        print("  export [format]     Export config (json/yaml)")
        print("  import <file>       Import configuration")
        print("  show [section]      Show configuration")
        print("  reset               Reset to defaults")
        print("  save                Save configuration")

if __name__ == '__main__':
    main()
