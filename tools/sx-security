#!/bin/bash
#
# SentinelX Security Manager
# Unified management for AppArmor, SELinux, and system hardening
#
# Copyright (C) 2026 WildanDev
# License: GPL v3

set -e

VERSION="2.0.0"
SCRIPT_NAME="sx-security"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check root
[[ $EUID -ne 0 ]] && { echo -e "${RED}Error: Must run as root${NC}"; exit 1; }

show_banner() {
    cat << 'EOF'
╔════════════════════════════════════════════════════════════╗
║           SENTINELX SECURITY MANAGER v2.0                  ║
║         Dual-Layer Protection: AppArmor + SELinux          ║
╚════════════════════════════════════════════════════════════╝
EOF
}

enable_apparmor() {
    echo -e "${CYAN}[*] Enabling AppArmor...${NC}"
    systemctl enable apparmor 2>/dev/null || true
    systemctl start apparmor 2>/dev/null || true
    
    # Load profiles
    if [ -d /etc/apparmor.d ]; then
        apparmor_parser -r /etc/apparmor.d/* 2>/dev/null || true
    fi
    echo -e "${GREEN}[✓] AppArmor enabled${NC}"
}

enable_selinux() {
    echo -e "${CYAN}[*] Configuring SELinux...${NC}"
    
    # Set to enforcing mode
    if command -v setenforce &>/dev/null; then
        setenforce 1 2>/dev/null || true
        echo -e "${GREEN}[✓] SELinux set to enforcing${NC}"
    fi
    
    # Update config
    if [ -f /etc/selinux/config ]; then
        sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config
    fi
}

system_hardening() {
    echo -e "${CYAN}[*] Applying system hardening...${NC}"
    
    # Kernel parameters
    cat > /etc/sysctl.d/99-sx-security.conf << 'EOF'
# SentinelX Security Hardening
kernel.dmesg_restrict=1
kernel.kptr_restrict=2
kernel.yama.ptrace_scope=2
kernel.unprivileged_bpf_disabled=1
kernel.unprivileged_userns_clone=0
net.ipv4.conf.all.rp_filter=1
net.ipv4.conf.default.rp_filter=1
net.ipv4.conf.all.accept_source_route=0
net.ipv4.conf.default.accept_source_route=0
net.ipv4.icmp_echo_ignore_broadcasts=1
net.ipv4.conf.all.send_redirects=0
net.ipv4.conf.default.send_redirects=0
fs.suid_dumpable=0
EOF
    
    sysctl -p /etc/sysctl.d/99-sx-security.conf >/dev/null 2>&1
    echo -e "${GREEN}[✓] Kernel hardening applied${NC}"
}

firewall_setup() {
    echo -e "${CYAN}[*] Configuring firewall...${NC}"
    
    if command -v ufw &>/dev/null; then
        ufw --force enable
        ufw default deny incoming
        ufw default allow outgoing
        ufw allow ssh
        echo -e "${GREEN}[✓] Firewall configured (ufw)${NC}"
    elif command -v firewall-cmd &>/dev/null; then
        systemctl enable --now firewalld
        firewall-cmd --set-default-zone=drop
        firewall-cmd --add-service=ssh --permanent
        firewall-cmd --reload
        echo -e "${GREEN}[✓] Firewall configured (firewalld)${NC}"
    fi
}

show_status() {
    show_banner
    echo ""
    
    # AppArmor status
    echo -e "${CYAN}AppArmor Status:${NC}"
    if command -v aa-status &>/dev/null; then
        aa-status --enabled && echo -e "  ${GREEN}✓ Enabled${NC}" || echo -e "  ${RED}✗ Disabled${NC}"
    else
        echo -e "  ${YELLOW}! Not installed${NC}"
    fi
    
    # SELinux status  
    echo -e "\n${CYAN}SELinux Status:${NC}"
    if command -v getenforce &>/dev/null; then
        STATUS=$(getenforce)
        [[ "$STATUS" == "Enforcing" ]] && echo -e "  ${GREEN}✓ Enforcing${NC}" || echo -e "  ${YELLOW}! $STATUS${NC}"
    else
        echo -e "  ${YELLOW}! Not installed${NC}"
    fi
    
    # Firewall status
    echo -e "\n${CYAN}Firewall Status:${NC}"
    if command -v ufw &>/dev/null; then
        ufw status | head -1
    elif systemctl is-active firewalld &>/dev/null; then
        echo -e "  ${GREEN}✓ Active (firewalld)${NC}"
    else
        echo -e "  ${YELLOW}! Not active${NC}"
    fi
    
    echo ""
}

case "${1:-status}" in
    enable)
        show_banner
        enable_apparmor
        enable_selinux
        system_hardening
        firewall_setup
        echo -e "\n${GREEN}[✓] Security hardening complete!${NC}"
        ;;
    status)
        show_status
        ;;
    *)
        echo "Usage: $SCRIPT_NAME {enable|status}"
        exit 1
        ;;
esac
