#!/bin/bash
#
# SentinelX System Update Manager
# Unified system updates with snapshot support
#
# Copyright (C) 2026 WildanDev
# License: GPL v3

set -e

VERSION="1.0.0"
SNAPSHOT_DIR="/.snapshots"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

[[ $EUID -ne 0 ]] && { echo -e "${RED}Error: Must run as root${NC}"; exit 1; }

show_banner() {
    cat << 'EOF'
╔════════════════════════════════════════════════════════════╗
║          SENTINELX SYSTEM UPDATE MANAGER                   ║
║        Atomic Updates with Automatic Snapshots             ║
╚════════════════════════════════════════════════════════════╝
EOF
}

create_snapshot() {
    echo -e "${CYAN}[*] Creating pre-update snapshot...${NC}"
    
    if command -v btrfs &>/dev/null && btrfs filesystem show / &>/dev/null; then
        local snapshot_name="pre-update-$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$SNAPSHOT_DIR"
        btrfs subvolume snapshot / "$SNAPSHOT_DIR/$snapshot_name" >/dev/null 2>&1 || true
        echo -e "${GREEN}[✓] Snapshot created: $snapshot_name${NC}"
        echo "$snapshot_name"
    else
        echo -e "${YELLOW}[!] Btrfs not available, skipping snapshot${NC}"
        echo ""
    fi
}

update_system() {
    show_banner
    echo ""
    
    # Create snapshot
    local snapshot
    snapshot=$(create_snapshot)
    
    # Update packages
    echo -e "\n${CYAN}[*] Updating system packages...${NC}"
    
    if command -v pacman &>/dev/null; then
        echo -e "${CYAN}  → Updating Arch packages...${NC}"
        pacman -Syu --noconfirm || {
            echo -e "${RED}[✗] Arch update failed${NC}"
            if [ -n "$snapshot" ]; then
                echo -e "${YELLOW}[!] Snapshot available for rollback: $snapshot${NC}"
            fi
            exit 1
        }
    fi
    
    if command -v dnf &>/dev/null; then
        echo -e "${CYAN}  → Updating Red Hat packages...${NC}"
        dnf upgrade -y || {
            echo -e "${RED}[✗] DNF update failed${NC}"
            if [ -n "$snapshot" ]; then
                echo -e "${YELLOW}[!] Snapshot available for rollback: $snapshot${NC}"
            fi
            exit 1
        }
    fi
    
    # Update firmware
    if command -v fwupdmgr &>/dev/null; then
        echo -e "\n${CYAN}[*] Checking firmware updates...${NC}"
        fwupdmgr refresh --force >/dev/null 2>&1 || true
        fwupdmgr update -y 2>/dev/null || true
    fi
    
    echo -e "\n${GREEN}[✓] System update complete!${NC}"
    echo -e "${CYAN}[*] Reboot recommended for kernel updates${NC}"
}

rollback_snapshot() {
    local snapshot_name="$1"
    
    if [ -z "$snapshot_name" ]; then
        echo -e "${RED}Error: Snapshot name required${NC}"
        echo "Usage: sx-update rollback <snapshot-name>"
        exit 1
    fi
    
    if [ ! -d "$SNAPSHOT_DIR/$snapshot_name" ]; then
        echo -e "${RED}Error: Snapshot not found: $snapshot_name${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}[!] Rolling back to snapshot: $snapshot_name${NC}"
    echo -e "${RED}[!] This will revert all changes since the snapshot was created${NC}"
    read -p "Continue? (yes/no): " confirm
    
    if [ "$confirm" == "yes" ]; then
        # This is a simplified rollback - actual implementation would need proper btrfs subvolume handling
        echo -e "${CYAN}[*] Rollback process would restore snapshot: $snapshot_name${NC}"
        echo -e "${YELLOW}[!] Please boot from recovery and manually restore snapshot${NC}"
    else
        echo "Rollback cancelled"
    fi
}

list_snapshots() {
    echo -e "${CYAN}Available snapshots:${NC}\n"
    
    if [ -d "$SNAPSHOT_DIR" ]; then
        ls -1 "$SNAPSHOT_DIR" | grep "pre-update" || echo "No snapshots found"
    else
        echo "No snapshots found"
    fi
}

case "${1:-update}" in
    update)
        update_system
        ;;
    rollback)
        rollback_snapshot "$2"
        ;;
    list)
        list_snapshots
        ;;
    *)
        show_banner
        echo -e "\nUsage: sx-update {update|rollback|list}"
        echo "  update   - Update system with snapshot"
        echo "  rollback - Rollback to a snapshot"
        echo "  list     - List available snapshots"
        ;;
esac
